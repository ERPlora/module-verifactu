{% load static %}
{% load i18n %}

{% if request.htmx %}
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "verifactu/partials/tabbar.html" with current_view='dashboard' %}
</ion-footer>
</div>
{% endif %}

<div class="ion-padding">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold" style="color: var(--ion-text-color);">Verifactu</h1>
        <p class="text-sm mt-1" style="color: var(--ion-color-medium);">{% trans "Spanish electronic invoicing compliance" %}</p>
    </div>

    <!-- Status Banner -->
    {% if not is_configured %}
    <ion-card class="m-0 mb-4" color="warning">
        <ion-card-content class="p-4">
            <div class="flex items-center gap-3">
                <ion-icon name="warning-outline" style="font-size: 24px;"></ion-icon>
                <div>
                    <div class="font-semibold">{% trans "Configuration Required" %}</div>
                    <div class="text-sm">{% trans "Please configure your certificate and software information in Settings." %}</div>
                </div>
                <ion-button size="small" fill="outline" color="dark"
                    hx-get="{% url 'verifactu:settings' %}"
                    hx-target="#dashboard-content"
                    hx-push-url="true">
                    {% trans "Configure" %}
                </ion-button>
            </div>
        </ion-card-content>
    </ion-card>
    {% endif %}

    <!-- System Status -->
    <ion-card class="m-0 mb-4">
        <ion-card-content class="p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    {% if status.mode.value == 'normal' %}
                    <div class="w-3 h-3 rounded-full bg-success"></div>
                    {% elif status.mode.value == 'offline' %}
                    <div class="w-3 h-3 rounded-full bg-danger"></div>
                    {% elif status.mode.value == 'degraded' %}
                    <div class="w-3 h-3 rounded-full bg-warning"></div>
                    {% else %}
                    <div class="w-3 h-3 rounded-full bg-primary"></div>
                    {% endif %}
                    <div>
                        <div class="font-semibold">{{ status.message }}</div>
                        {% if status.queue_size > 0 %}
                        <div class="text-sm" style="color: var(--ion-color-medium);">
                            {{ status.queue_size }} {% trans "records in queue" %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <ion-button size="small" fill="clear"
                    hx-get="{% url 'verifactu:contingency' %}"
                    hx-target="#dashboard-content"
                    hx-push-url="true">
                    {% trans "Details" %}
                    <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
                </ion-button>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-content class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="document-text-outline" class="text-xl text-primary"></ion-icon>
                    </div>
                    <div>
                        <div class="text-xs text-medium">{% trans "Total Records" %}</div>
                        <div class="text-xl font-semibold">{{ total_records }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="today-outline" class="text-xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-xs text-medium">{% trans "Today" %}</div>
                        <div class="text-xl font-semibold">{{ today_records }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-tertiary/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="calendar-outline" class="text-xl text-tertiary"></ion-icon>
                    </div>
                    <div>
                        <div class="text-xs text-medium">{% trans "This Month" %}</div>
                        <div class="text-xl font-semibold">{{ month_records }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-warning/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="time-outline" class="text-xl text-warning"></ion-icon>
                    </div>
                    <div>
                        <div class="text-xs text-medium">{% trans "Pending" %}</div>
                        <div class="text-xl font-semibold">{{ pending_records }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Recent Records -->
    <ion-card class="m-0 mb-4">
        <ion-card-header>
            <div class="flex justify-between items-center">
                <ion-card-title>{% trans "Recent Records" %}</ion-card-title>
                <ion-button size="small" fill="clear"
                    hx-get="{% url 'verifactu:records' %}"
                    hx-target="#dashboard-content"
                    hx-push-url="true">
                    {% trans "View All" %}
                </ion-button>
            </div>
        </ion-card-header>
        <ion-card-content class="p-0">
            {% if recent_records %}
            <ion-list>
                {% for record in recent_records %}
                <ion-item button
                    hx-get="{% url 'verifactu:record_detail' record.id %}"
                    hx-target="#dashboard-content"
                    hx-push-url="true">
                    <ion-icon slot="start" name="{% if record.record_type == 'alta' %}add-circle-outline{% else %}remove-circle-outline{% endif %}"
                        color="{% if record.record_type == 'alta' %}success{% else %}danger{% endif %}"></ion-icon>
                    <ion-label>
                        <h3>{{ record.invoice_number }}</h3>
                        <p>{{ record.generation_timestamp|date:"Y-m-d H:i" }}</p>
                    </ion-label>
                    {% if record.transmission_status == 'sent' %}
                    <ion-badge color="success" slot="end">{% trans "Sent" %}</ion-badge>
                    {% elif record.transmission_status == 'pending' %}
                    <ion-badge color="warning" slot="end">{% trans "Pending" %}</ion-badge>
                    {% elif record.transmission_status == 'error' %}
                    <ion-badge color="danger" slot="end">{% trans "Error" %}</ion-badge>
                    {% endif %}
                </ion-item>
                {% endfor %}
            </ion-list>
            {% else %}
            <div class="text-center py-8">
                <ion-icon name="document-text-outline" style="font-size: 48px; color: var(--ion-color-medium);"></ion-icon>
                <p class="mt-2" style="color: var(--ion-color-medium);">{% trans "No records yet" %}</p>
            </div>
            {% endif %}
        </ion-card-content>
    </ion-card>

    <!-- Recent Alerts -->
    {% if recent_events %}
    <ion-card class="m-0">
        <ion-card-header>
            <ion-card-title>{% trans "Recent Alerts" %}</ion-card-title>
        </ion-card-header>
        <ion-card-content class="p-0">
            <ion-list>
                {% for event in recent_events %}
                <ion-item>
                    <ion-icon slot="start"
                        name="{% if event.event_type == 'error' %}alert-circle-outline{% else %}warning-outline{% endif %}"
                        color="{% if event.event_type == 'error' %}danger{% else %}warning{% endif %}">
                    </ion-icon>
                    <ion-label>
                        <h3>{{ event.description|truncatewords:10 }}</h3>
                        <p>{{ event.timestamp|date:"Y-m-d H:i" }}</p>
                    </ion-label>
                </ion-item>
                {% endfor %}
            </ion-list>
        </ion-card-content>
    </ion-card>
    {% endif %}
</div>
